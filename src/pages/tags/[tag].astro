---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostCard from "../../components/PostCard.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  // Get all unique tags
  const tags = new Set<string>();
  posts.forEach((post) => {
    const postTags = post.data.tags || [];
    postTags.forEach((tag) => tags.add(tag));
  });

  return Array.from(tags).map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((post) => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

interface Props {
  tag: string;
  posts: Awaited<ReturnType<typeof getCollection<"blog">>>;
}

const { tag, posts } = Astro.props;
---

<BaseLayout title={`Tag: ${tag}`}>
  <h1 class="mb-8">
    <span class="opacity-60">Tag:</span>
    #{tag}
    <span class="text-lg opacity-60">({posts.length})</span>
  </h1>

  {posts.map((post) => <PostCard post={post} />)}
</BaseLayout>
